---
import SiteLayout from "../../components/layout/SiteLayout.astro";
import TagList from "../../components/blog/TagList.astro";
import { getCollection, getEntry, render } from "astro:content";
import { Image } from "astro:assets";
import { pickLandscape } from "@/utils/hashUtils";

export async function getStaticPaths() {
	// const posts = await getCollection('blog');
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  return posts.map((post) => ({
	params: { id: post.id },
	// params: { slug: post.id },
	// props: post,
    // props: { post },
  }));
}

// Auto-discover landscapes under src/assets/landscapes
const landscapeModules = import.meta.glob<{ default: ImageMetadata }>(
  "../../assets/landscapes/*.{jpg,jpeg,png,webp,avif}",
  { eager: true }
);

// Extract the default export (ImageMetadata objects)
const landscapes: ImageMetadata[] = Object.values(landscapeModules).map(
  (mod) => mod.default
);

// const post = Astro.props;
// const { post } = Astro.props;

const idParam = Astro.params.id;
const id = Array.isArray(idParam) ? idParam.join("/") : idParam;

// Fetch the entry in a way that supports rendering
const post = await getEntry("blog", id);
if (!post) throw new Error(`Post not found: ${id}`);
const hero = pickLandscape(landscapes, post.id);

const { Content } = await render(post);

// type Props = CollectionEntry<'blog'>;
// const { Content } = await render(post);
const seoTitle = post.data.title ?? "Blog Post";
const seoDescription =
  post.data.description ??
  "Read this blog post on my Astro site.";

const dateText = post.data.pubDate.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "2-digit",
});
---
<SiteLayout title={seoTitle} description={seoDescription}>
  <article class="prose">
    <div class="hero-image">
			{hero && <Image width={1020} height={510} src={hero} alt="" />}
		</div>
    <h1>{post.data.title}</h1>
    <p class="meta">{dateText}</p>
    <TagList tags={post.data.tags} />
    <hr />
    <Content />
  </article>
</SiteLayout>

<!-- <BlogPost {...post.data}>
	<Content />
</BlogPost> -->
